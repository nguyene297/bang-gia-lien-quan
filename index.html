<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tính sao & Doanh thu Liên Quân</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 10px; background: #f7f7f7; }
    h2 { margin-top: 20px; }
    .section { background: #fff; padding: 15px; margin-bottom: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);}
    label { display: block; margin-top: 10px; }
    input, select, button { width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 5px; }
    button { background: #007bff; color: #fff; border: none; font-weight: bold; cursor: pointer; }
    button:hover { background: #0056b3; }
    .result { margin-top: 10px; font-weight: bold; color: green; }
    .note { font-size: 0.9em; color: #444; margin-top: 5px; }
  </style>
</head>
<body>
  <h2>Thông tin chung</h2>
  <div class="section">
    <label>Thượng đế (Khách hàng):</label>
    <input type="text" id="khachHang">
    <label>Nô lệ (Nhân viên):</label>
    <input type="text" id="nhanVien">
  </div>

  <h2>Cày rank</h2>
  <div class="section">
    <label>Bậc hiện tại:</label>
    <select id="rankFrom"></select>
    <label>Sao hiện tại:</label>
    <input type="number" id="saoFrom" min="0" value="0">
    <label>Bậc mục tiêu:</label>
    <select id="rankTo"></select>
    <label>Sao mục tiêu:</label>
    <input type="number" id="saoTo" min="1" value="1">
    <button onclick="tinhRank()">Tính giá cày rank</button>
    <div class="result" id="ketQuaRank"></div>
  </div>

  <h2>Thuê slot</h2>
  <div class="section">
    <label>Số giờ thuê:</label>
    <input type="number" id="soGio" min="1" value="1">
    <button onclick="tinhSlot()">Tính giá thuê slot</button>
    <div class="result" id="ketQuaSlot"></div>
  </div>

  <h2>Thống kê</h2>
  <div class="section">
    <button onclick="guiDon()">Lưu đơn</button>
    <button onclick="thongKe()">Xem doanh thu tháng</button>
    <div class="result" id="doanhThu"></div>
  </div>

  <div class="note">
    * Chiến tướng: từ 70★ trở lên tính 20.000đ/★ (giá áp theo sao trước bước).
  </div>

<script>
const TIERS = ["Tinh Anh", "Kim Cương", "Cao Thủ", "Đại Cao Thủ", "Chiến tướng"];
const prices = {"Tinh Anh": 2000, "Kim Cương": 5000, "Cao Thủ": 10000, "Đại Cao Thủ": 15000, "Chiến tướng": 15000};
const CT_HIGH_THRESHOLD = 70, CT_HIGH_PRICE = 20000;

function fillRankOptions(){
  let opts="";
  TIERS.forEach((t,i)=>{opts += `<option value="${i}">${t}</option>`;});
  document.getElementById("rankFrom").innerHTML=opts;
  document.getElementById("rankTo").innerHTML=opts;
}
fillRankOptions();

function priceForStep(prev){
  let tier = TIERS[prev.ti];
  if(tier==="Chiến tướng"){
    let abs = Number(prev.abs||0);
    if(abs>=CT_HIGH_THRESHOLD) return CT_HIGH_PRICE;
    return prices["Chiến tướng"];
  }
  return prices[tier];
}

// So sánh trạng thái
function lt(a,b){ return a.ti<b.ti || (a.ti===b.ti && a.abs<b.abs); }
function stepOnce(st,carry){
  st.abs++; st.star++;
  let max=5;
  if(TIERS[st.ti]==="Cao Thủ") max=9;
  if(TIERS[st.ti]==="Đại Cao Thủ") max=49;
  if(TIERS[st.ti]==="Chiến tướng") max=150;
  if(st.star>max){ st.ti++; st.star=1; st.abs++; }
}

function* starPath(from,to){
  let cur=JSON.parse(JSON.stringify(from));
  let segFrom=JSON.parse(JSON.stringify(cur)), segTier=cur.ti, segPrice=priceForStep(cur), segStars=0;
  while(lt(cur,to)){
    let prev=JSON.parse(JSON.stringify(cur));
    let curPrice=priceForStep(prev);
    stepOnce(cur);
    if(curPrice!==segPrice || prev.ti!==segTier){
      if(segStars>0) yield {from:{...segFrom},to:{...prev},stars:segStars,pricePerStar:segPrice};
      segFrom={...prev}; segTier=prev.ti; segPrice=curPrice; segStars=0;
    }
    segStars++;
  }
  if(segStars>0) yield {from:{...segFrom},to:{...to},stars:segStars,pricePerStar:segPrice};
}

function tinhRank(){
  let from={ti:+rankFrom.value,star:+saoFrom.value,abs:+saoFrom.value}, to={ti:+rankTo.value,star:+saoTo.value,abs:+saoTo.value};
  let total=0,detail="";
  for(let seg of starPath(from,to)){
    total+=seg.stars*seg.pricePerStar;
    detail+=`Từ ${TIERS[seg.from.ti]} ${seg.from.star}★ đến ${TIERS[seg.to.ti]} ${seg.to.star}★: ${seg.stars}★ × ${seg.pricePerStar}đ<br>`;
  }
  document.getElementById("ketQuaRank").innerHTML=`${detail}<b>Tổng: ${total.toLocaleString()}đ</b>`;
  return total;
}

function tinhSlot(){
  let h=+soGio.value; let total=h*30000;
  document.getElementById("ketQuaSlot").innerText=`${h} giờ = ${total.toLocaleString()}đ`;
  return total;
}

function guiDon(){
  let k=document.getElementById("khachHang").value, n=document.getElementById("nhanVien").value;
  let tienRank=tinhRank(), tienSlot=tinhSlot();
  let data={khach:k,nhanvien:n,rank:tienRank,slot:tienSlot};
  fetch("YOUR_SCRIPT_URL", {method:"POST",body:JSON.stringify(data)});
  alert("Đơn đã lưu!");
}

function thongKe(){
  fetch("https://script.google.com/macros/s/AKfycbzZO7OrMVvXYkCeQPY0FHut-5CeEVFHGprAxzQHX7p66yaZF0-NI9f4rXGrHd5wGKX6/exec?action=thongke").then(r=>r.json()).then(d=>{
    document.getElementById("doanhThu").innerText="Tổng doanh thu tháng: "+d.total.toLocaleString()+"đ";
  });
}
</script>
</body>
</html>
