<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>T√≠nh Sao & Gi√° C√†y Rank Li√™n Qu√¢n</title>
  <style>
    :root{--bg:#0f172a;--card:#111827;--muted:#94a3b8;--fg:#e5e7eb;--acc:#22c55e;--border:#1f2937;--warn:#f59e0b;}
    html,body{height:100%}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: linear-gradient(160deg, #0b1020, #111827 45%, #0b1020); color:var(--fg);
      display:flex; align-items:center; justify-content:center; padding:16px;
    }
    .wrap{max-width:980px; width:100%;}
    .card{
      background:rgba(17,24,39,.9);
      border:1px solid var(--border); border-radius:18px; padding:16px; box-shadow: 0 15px 40px rgba(0,0,0,.35);
      backdrop-filter: blur(6px);
    }
    h1{margin:0 0 8px 0; font-size: clamp(18px, 3.6vw, 28px); letter-spacing:.2px}
    p.lead{margin:0 0 12px 0; color:var(--muted); font-size:14px; line-height:1.4}
    .grid{display:grid; grid-template-columns: repeat(6, 1fr); gap:12px; margin-top:12px}
    .col-2{grid-column: span 2}
    .col-3{grid-column: span 3}
    .col-4{grid-column: span 4}
    .col-6{grid-column: span 6}
    .pane{background:#0b1220; border:1px solid var(--border); border-radius:14px; padding:12px}
    label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
    select, input[type="number"]{
      width:100%; padding:12px 12px; border-radius:10px; border:1px solid var(--border); background:#0e1627; color:var(--fg);
      font-size:15px; outline:none; min-height:44px;
    }
    .controls{display:grid; grid-template-columns:1.2fr .8fr .8fr; gap:8px}
    .inline{display:flex; align-items:center; gap:8px; flex-wrap:wrap}
    .btn{
      cursor:pointer; border:1px solid #2a3446; background:#0e1627; color:var(--fg);
      padding:12px 14px; border-radius:12px; font-weight:700; min-height:44px;
    }
    .btn.primary{background:var(--acc); border-color:#16a34a; color:#052e16}
    .stat{
      background:linear-gradient(180deg, #0a1426, #0c1220); border:1px dashed #22304a; border-radius:14px; padding:14px
    }
    .big{font-size: clamp(20px, 5vw, 36px); font-weight:800}
    .muted{color:var(--muted)}
    .table-wrap{width:100%; overflow-x:auto; border-radius:10px}
    table{width:100%; border-collapse:collapse; font-size:14px; min-width:560px}
    th, td{border-bottom:1px solid #1f2937; padding:8px 6px; text-align:left}
    .price-edit{width:110px}
    .footer{margin-top:10px; font-size:12px; color:#9ca3af}
    .note{font-size:12px; color:#c7d2fe}
    .pill{display:inline-block; padding:2px 8px; border:1px solid #334155; border-radius:999px; font-size:12px; color:#cbd5e1}
    .ct-badge{font-size:12px; color:#fde68a}
    .warn{font-size:12px; color:var(--warn); margin-top:6px}
    /* Tablet: 1024‚Üì => 2 c·ªôt ch√≠nh */
    @media (max-width: 1024px){
      .grid{grid-template-columns: 1fr 1fr;}
      .col-2,.col-3,.col-4,.col-6{grid-column: span 2;}
    }
    /* Mobile: 640‚Üì => 1 c·ªôt, controls x·∫øp d·ªçc, n√∫t b·∫•m to */
    @media (max-width: 640px){
      body{padding:10px}
      .grid{grid-template-columns: 1fr;}
      .col-2,.col-3,.col-4,.col-6{grid-column: span 1;}
      .controls{grid-template-columns:1fr; gap:8px}
      .pane{padding:10px}
      .btn{width:100%}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>üõ°Ô∏è T√≠nh Sao & Gi√° C√†y Rank Li√™n Qu√¢n</h1>
      <p class="lead">Ch·ªçn rank hi·ªán t·∫°i v√† m·ª•c ti√™u. C√¥ng c·ª• s·∫Ω t√≠nh t·ªïng <b>sao</b> c·∫ßn c√†y v√† <b>s·ªë ti·ªÅn</b> theo b·∫£ng gi√°. 
        <span class="ct-badge">Chi·∫øn t∆∞·ªõng: nh·∫≠p t·ªïng sao (‚â• 50) ‚Äî kh√¥ng gi·ªõi h·∫°n t·ªëi ƒëa.</span>
      </p>

      <div class="grid">
        <div class="pane col-3">
          <label>Rank hi·ªán t·∫°i</label>
          <div class="controls">
            <select id="fromTier"></select>
            <div id="fromDivWrap"></div>
            <div id="fromStarsWrap"></div>
          </div>
          <div id="fromWarn" class="warn" style="display:none">Chi·∫øn t∆∞·ªõng ph·∫£i ‚â• 50 sao.</div>
        </div>

        <div class="pane col-3">
          <label>Rank m·ª•c ti√™u</label>
          <div class="controls">
            <select id="toTier"></select>
            <div id="toDivWrap"></div>
            <div id="toStarsWrap"></div>
          </div>
          <div id="toWarn" class="warn" style="display:none">Chi·∫øn t∆∞·ªõng ph·∫£i ‚â• 50 sao.</div>
        </div>

        <div class="pane col-6">
          <div class="inline" id="actionRow" style="justify-content:space-between">
            <div class="inline">
              <input id="carry" type="checkbox" checked style="width:20px; height:20px;"/>
              <label for="carry" style="margin:0">C·ªông 1 sao khi thƒÉng h·∫°ng <span class="pill">VD KC3 ‚Üí KC1 = 9 sao</span></label>
            </div>
            <div class="inline" style="gap:8px">
              <button class="btn" id="swap">ƒê·ªïi ch·ªó (‚Üë‚Üì)</button>
              <button class="btn primary" id="calc">T√≠nh ngay</button>
            </div>
          </div>
        </div>

        <div class="pane col-4 stat">
          <div class="muted">T·ªïng s·ªë sao</div>
          <div id="starsTotal" class="big">0</div>
        </div>
        <div class="pane col-2 stat">
          <div class="muted">T·ªïng ti·ªÅn (VND)</div>
          <div id="priceTotal" class="big">0</div>
        </div>

        <div class="pane col-6">
          <div class="inline" style="justify-content:space-between">
            <div>
              <b>B·∫£ng gi√° m·ªói b·∫≠c</b>
              <div class="note">B·∫°n c√≥ th·ªÉ ch·ªânh ƒë∆°n gi√° (ƒë/ng√¥i sao) theo √Ω m√¨nh.</div>
            </div>
            <button class="btn" id="resetPrice">Kh√¥i ph·ª•c m·∫∑c ƒë·ªãnh</button>
          </div>
          <div class="table-wrap">
            <table>
              <thead><tr><th>B·∫≠c rank</th><th>Gi√° (ƒë / 1 sao)</th></tr></thead>
              <tbody id="priceTable"></tbody>
            </table>
          </div>
        </div>

        <div class="pane col-6">
          <b>Chi ti·∫øt t√≠nh to√°n</b>
          <div class="table-wrap">
            <table>
              <thead><tr><th>Kho·∫£ng</th><th>S·ªë sao</th><th>ƒê∆°n gi√°</th><th>Th√†nh ti·ªÅn</th></tr></thead>
              <tbody id="breakdown"></tbody>
            </table>
          </div>
          <div class="footer">M·∫∑c ƒë·ªãnh: m·ªói division (5‚Üí1) c√≥ 5 sao. <b>Chi·∫øn t∆∞·ªõng:</b> d√πng t·ªïng sao (‚â• 50); c√≥ th·ªÉ nh·∫≠p tu·ª≥ √Ω.</div>
        </div>
      </div>
    </div>
  </div>

<script>
// ---------- CONFIG ----------
const DIVS = [5,4,3,2,1];         // Division l·ªõn -> nh·ªè
const MAX_STARS = 5;               // 5 sao m·ªói division
const TIERS = [
  "Kim C∆∞∆°ng",
  "Tinh Anh",
  "Cao th·ªß",
  "ƒê·∫°i cao th·ªß",
  "Chi·∫øn t∆∞·ªõng"
];

// Gi√° m·∫∑c ƒë·ªãnh theo ·∫£nh: 3k, 5k, 7k, 10k, 15k / 1 sao
const DEFAULT_PRICES = {
  "Kim C∆∞∆°ng": 3000,
  "Tinh Anh": 5000,
  "Cao th·ªß": 7000,
  "ƒê·∫°i cao th·ªß": 10000,
  "Chi·∫øn t∆∞·ªõng": 15000
};

const CT_MIN = 50; // CT ph·∫£i >= 50

// ---------- STATE ----------
let prices = {...DEFAULT_PRICES};

// ---------- HELPERS ----------
const el = (id) => document.getElementById(id);
function formatVND(n){
  try { return n.toLocaleString("vi-VN"); } catch { return String(n); }
}
function option(list){ return list.map(v => `<option value="${v}">${v}</option>`).join(""); }
function indexOfTier(tier){ return TIERS.indexOf(tier); }

function mkDivSelect(id){
  return `<select id="${id}">${option(DIVS)}</select>`;
}
function mkStarSelect(id){
  return `<select id="${id}">${option([0,1,2,3,4])}</select>`;
}
function mkCTInput(id){
  return `<input id="${id}" type="number" min="${CT_MIN}" step="1" placeholder="‚â• ${CT_MIN}" value="${CT_MIN}"/>`;
}

function renderInputs(prefix){
  const tier = el(prefix+"Tier").value;
  const divWrap = el(prefix+"DivWrap");
  const starsWrap = el(prefix+"StarsWrap");
  const warn = el(prefix+"Warn");
  if(tier === "Chi·∫øn t∆∞·ªõng"){
    divWrap.innerHTML = mkCTInput(prefix+"CTStars");
    starsWrap.innerHTML = ""; // kh√¥ng d√πng
    warn.style.display = "block";
  }else{
    divWrap.innerHTML = mkDivSelect(prefix+"Div");
    starsWrap.innerHTML = mkStarSelect(prefix+"Stars");
    warn.style.display = "none";
  }
  // bind change events to recalc
  ["Div","Stars","CTStars"].forEach(suffix=>{
    const node = document.getElementById(prefix+suffix);
    if(node) node.addEventListener("change", calc);
  });
}

function loadSelectors(){
  el("fromTier").innerHTML = option(TIERS);
  el("toTier").innerHTML   = option(TIERS);
  ["from","to"].forEach(renderInputs);
  // defaults
  el("fromTier").value = "Kim C∆∞∆°ng";
  el("toTier").value = "Kim C∆∞∆°ng";
  renderInputs("from");
  renderInputs("to");
  // set default states
  if(el("fromDiv")) el("fromDiv").value = 3;
  if(el("fromStars")) el("fromStars").value = 0;
  if(el("toDiv")) el("toDiv").value = 1;
  if(el("toStars")) el("toStars").value = 0;
}

function loadPriceTable(){
  const tb = el("priceTable");
  tb.innerHTML = TIERS.map(t => `
    <tr>
      <td>${t}</td>
      <td>
        <input class="price-edit" type="number" min="0" step="500" value="${prices[t]}" data-tier="${t}"/>
      </td>
    </tr>
  `).join("");
  tb.querySelectorAll("input").forEach(inp => {
    inp.addEventListener("input", e => {
      const tier = e.target.dataset.tier;
      const val = Number(e.target.value||0);
      prices[tier] = Math.max(0, Math.round(val));
      calc();
    });
  });
}

function getCT(prefix){
  const elIn = el(prefix+"CTStars");
  let v = Number((elIn?.value ?? CT_MIN));
  if(isNaN(v) || v < CT_MIN){ v = CT_MIN; if(elIn){ elIn.value = CT_MIN; } }
  return Math.floor(v);
}

function getState(prefix){
  const tier = el(prefix+"Tier").value;
  if(tier === "Chi·∫øn t∆∞·ªõng"){
    return {ti: indexOfTier(tier), ct: getCT(prefix)};
  }else{
    return {
      ti: indexOfTier(tier),
      di: Number(el(prefix+"Div").value),
      st: Number(el(prefix+"Stars").value)
    };
  }
}
function setState(prefix, obj){
  el(prefix+"Tier").value = TIERS[obj.ti];
  renderInputs(prefix);
  if(obj.ti === indexOfTier("Chi·∫øn t∆∞·ªõng")){
    if(el(prefix+"CTStars")) el(prefix+"CTStars").value = Math.max(CT_MIN, obj.ct ?? CT_MIN);
  }else{
    if(el(prefix+"Div")) el(prefix+"Div").value = obj.di;
    if(el(prefix+"Stars")) el(prefix+"Stars").value = obj.st;
  }
}

// So s√°nh a < b theo ti·∫øn tr√¨nh rank
function lt(a,b){
  if(a.ti !== b.ti) return a.ti < b.ti;
  if(a.ti === indexOfTier("Chi·∫øn t∆∞·ªõng")){
    return (a.ct ?? CT_MIN) < (b.ct ?? CT_MIN);
  }else{
    if(a.di !== b.di) return a.di > b.di; // 5 -> 4 -> ... -> 1
    return a.st < b.st;
  }
}
function notLT(a,b){ return !lt(a,b); }

// generator ƒëi t·ª´ng sao, t√°ch theo tier ƒë·ªÉ √°p gi√°
function* starPath(from, to, carryStar){
  let cur = JSON.parse(JSON.stringify(from));
  const lastTier = indexOfTier("Chi·∫øn t∆∞·ªõng");

  const step = () => {
    if(cur.ti < lastTier){
      cur.st += 1;
      if(cur.st >= MAX_STARS){
        cur.st = carryStar ? 1 : 0;
        if(cur.di > 1){
          cur.di -= 1;
        }else{
          // sang tier m·ªõi
          cur.ti += 1;
          if(cur.ti < lastTier){
            cur.di = 5;
          }else{
            // v√†o Chi·∫øn t∆∞·ªõng
            cur.ct = Math.max(CT_MIN, carryStar ? CT_MIN + 1 : CT_MIN);
            delete cur.di; delete cur.st;
          }
        }
      }
    }else{
      // ·ªü Chi·∫øn t∆∞·ªõng: tƒÉng t·ªïng sao
      cur.ct = Math.max(CT_MIN, (cur.ct ?? CT_MIN) + 1);
    }
  };

  let stars = 0;
  let segFrom = JSON.parse(JSON.stringify(cur));
  let segTier = cur.ti;

  while(lt(cur, to)){
    step();
    stars += 1;
    if(cur.ti !== segTier){
      yield {from: {...segFrom}, to: {...cur}, stars, pricePerStar: prices[TIERS[segTier]]};
      segFrom = JSON.parse(JSON.stringify(cur)); segTier = cur.ti; stars = 0;
    }
  }
  if(stars>0){
    yield {from: {...segFrom}, to: {...to}, stars, pricePerStar: prices[TIERS[segTier]]};
  }
}

// ---------- CALC ----------
function labelOf(state){
  const tierName = TIERS[state.ti];
  if(tierName === "Chi·∫øn t∆∞·ªõng"){
    const ct = state.ct ?? CT_MIN;
    return `${tierName} ‚Ä¢ ${ct} sao`;
  }else{
    return `${tierName} ${state.di} ‚Ä¢ ${state.st}/${MAX_STARS}`;
  }
}

function calc(){
  const from = getState("from");
  const to   = getState("to");
  const carry = el("carry").checked;
  const bd = el("breakdown");
  bd.innerHTML = "";

  if(notLT(from, to)){
    el("starsTotal").textContent = "0";
    el("priceTotal").textContent = "0";
    bd.innerHTML = `<tr><td colspan="4"><span class="muted">M·ª•c ti√™u ph·∫£i cao h∆°n hi·ªán t·∫°i.</span></td></tr>`;
    return;
  }

  let starsTotal = 0, priceTotal = 0;
  for(const seg of starPath(from, to, carry)){
    starsTotal += seg.stars;
    const money = seg.stars * seg.pricePerStar;
    priceTotal += money;
    bd.innerHTML += `<tr>
      <td>${labelOf(seg.from)} ‚Üí ${labelOf(seg.to)}</td>
      <td>${seg.stars}</td>
      <td>${formatVND(seg.pricePerStar)}</td>
      <td><b>${formatVND(money)}</b></td>
    </tr>`;
  }
  el("starsTotal").textContent = formatVND(starsTotal);
  el("priceTotal").textContent = formatVND(priceTotal);
}

function swap(){
  const a = getState("from");
  const b = getState("to");
  setState("from", b);
  setState("to", a);
  calc();
}

// ---------- INIT ----------
loadSelectors();
loadPriceTable();
// M·∫∑c ƒë·ªãnh: t·ª´ Kim C∆∞∆°ng 3 (0 sao) -> Kim C∆∞∆°ng 1 (0 sao)
setState("from", {ti:indexOfTier("Kim C∆∞∆°ng"), di:3, st:0});
setState("to",   {ti:indexOfTier("Kim C∆∞∆°ng"), di:1, st:0});
calc();

// Listeners
["fromTier","toTier"].forEach(id => {
  el(id).addEventListener("change", e => { renderInputs(id.replace("Tier","")); calc(); });
});
el("calc").addEventListener("click", calc);
el("swap").addEventListener("click", swap);
el("resetPrice").addEventListener("click", () => { prices = {...DEFAULT_PRICES}; loadPriceTable(); calc(); });
["carry"].forEach(id=> el(id).addEventListener("change", calc));
</script>
</body>
</html>
