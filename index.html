<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Tính Giá Liên Quân</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f9f9f9; }
    header { background:#4CAF50; color:white; text-align:center; padding:10px; }
    main { padding:10px; }
    .section { background:#fff; border-radius:8px; padding:15px; margin-bottom:15px; box-shadow:0 2px 4px rgba(0,0,0,0.1); }
    label { display:block; margin-top:8px; }
    input, select { width:100%; padding:8px; margin-top:4px; border:1px solid #ccc; border-radius:4px; }
    button { margin-top:10px; padding:10px; width:100%; background:#4CAF50; border:none; border-radius:5px; color:white; font-size:16px; }
    button:hover { background:#45a049; }
    table { width:100%; border-collapse:collapse; margin-top:10px; font-size:14px; }
    table, th, td { border:1px solid #ccc; }
    th, td { padding:6px; text-align:center; }
    .result { font-weight:bold; color:#d9534f; margin-top:10px; text-align:center; }
    .note { font-size:13px; color:#555; margin-top:5px; }
    @media (max-width:600px) {
      table, th, td { font-size:12px; }
      button { font-size:14px; }
    }
  </style>
</head>
<body>
<header>
  <h1>Quản lý cày thuê Liên Quân</h1>
</header>
<main>
  <!-- Thông tin chung -->
  <div class="section">
    <h2>Thông tin chung</h2>
    <label>Thượng đế (Khách hàng): <input type="text" id="khach"></label>
    <label>Nô lệ (Nhân viên): <input type="text" id="nhanvien"></label>
  </div>

  <!-- Cày rank -->
  <div class="section">
    <h2>Cày Rank</h2>
    <label>Từ rank: 
      <select id="fromRank"></select>
    </label>
    <label>Sao hiện tại: <input type="number" id="fromStar" min="0"></label>
    <label>Đến rank: 
      <select id="toRank"></select>
    </label>
    <label>Sao mục tiêu: <input type="number" id="toStar" min="1"></label>
    <button onclick="calcRank()">Tính giá Cày Rank</button>
    <div id="rankResult" class="result"></div>
    <table id="rankTable" style="display:none;">
      <thead><tr><th>Từ</th><th>Đến</th><th>Số sao</th><th>Đơn giá</th><th>Thành tiền</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Thuê slot -->
  <div class="section">
    <h2>Thuê Slot</h2>
    <label>Số giờ thuê: <input type="number" id="slotHour" min="1"></label>
    <button onclick="calcSlot()">Tính giá Thuê Slot</button>
    <div id="slotResult" class="result"></div>
  </div>

  <!-- Doanh thu -->
  <div class="section">
    <h2>Doanh thu</h2>
    <button onclick="getRevenue()">Thống kê doanh thu tháng</button>
    <div id="revenueResult" class="result"></div>
  </div>
</main>

<script>
  const TIERS = ["Tinh 4","Tinh 3","Tinh 2","Tinh 1",
                 "Kim cương 5","Kim cương 4","Kim cương 3","Kim cương 2","Kim cương 1",
                 "Tinh Anh 5","Tinh Anh 4","Tinh Anh 3","Tinh Anh 2","Tinh Anh 1",
                 "Cao Thủ","Đại Cao Thủ","Chiến tướng"];
  const STAR_LIMITS = {
    "Tinh 4":5,"Tinh 3":5,"Tinh 2":5,"Tinh 1":5,
    "Kim cương 5":5,"Kim cương 4":5,"Kim cương 3":5,"Kim cương 2":5,"Kim cương 1":5,
    "Tinh Anh 5":5,"Tinh Anh 4":5,"Tinh Anh 3":5,"Tinh Anh 2":5,"Tinh Anh 1":5,
    "Cao Thủ":9,"Đại Cao Thủ":49,"Chiến tướng":150
  };
  const PRICES = {
    "Tinh":3000,"Kim cương":5000,"Tinh Anh":7000,
    "Cao Thủ":10000,"Đại Cao Thủ":15000,"Chiến tướng":15000
  };
  const CT_HIGH_THRESHOLD = 70;
  const CT_HIGH_PRICE = 20000;
  const SLOT_PRICE = 30000;

  // populate dropdown
  const fromSel = document.getElementById("fromRank");
  const toSel = document.getElementById("toRank");
  TIERS.forEach(t => {
    let o1=document.createElement("option"); o1.value=t; o1.text=t; fromSel.add(o1);
    let o2=document.createElement("option"); o2.value=t; o2.text=t; toSel.add(o2);
  });

  function priceForStep(tier, starBefore){
    if(tier==="Chiến tướng"){
      return (starBefore>=CT_HIGH_THRESHOLD) ? CT_HIGH_PRICE : PRICES["Chiến tướng"];
    }
    if(tier.startsWith("Tinh ")) return PRICES["Tinh"];
    if(tier.startsWith("Kim cương")) return PRICES["Kim cương"];
    if(tier.startsWith("Tinh Anh")) return PRICES["Tinh Anh"];
    return PRICES[tier];
  }

  function calcRank(){
    const fromRank=fromSel.value, toRank=toSel.value;
    let fromStar=parseInt(document.getElementById("fromStar").value)||0;
    let toStar=parseInt(document.getElementById("toStar").value)||1;
    let fromIndex=TIERS.indexOf(fromRank), toIndex=TIERS.indexOf(toRank);
    if(fromIndex>toIndex || (fromIndex===toIndex && fromStar>=toStar)){
      alert("Mốc mục tiêu phải cao hơn mốc ban đầu"); return;
    }
    let total=0, tbody=document.querySelector("#rankTable tbody"); tbody.innerHTML="";
    let curTier=fromRank, curIndex=fromIndex, curStar=fromStar;
    while(curIndex<toIndex || (curIndex===toIndex && curStar<toStar)){
      let starBefore=curStar;
      let price=priceForStep(curTier, starBefore);
      curStar++;
      total+=price;
      if(curStar>STAR_LIMITS[curTier]){
        curIndex++; curTier=TIERS[curIndex]; curStar=1; // khi lên rank mới thì sao bắt đầu từ 1
      }
    }
    document.getElementById("rankResult").innerText="Tổng tiền: "+total.toLocaleString()+" đ";
  }

  function calcSlot(){
    const h=parseInt(document.getElementById("slotHour").value)||0;
    if(h<=0){ alert("Nhập số giờ hợp lệ"); return; }
    const total=h*SLOT_PRICE;
    document.getElementById("slotResult").innerText="Tổng tiền: "+total.toLocaleString()+" đ";
  }

  async function getRevenue(){
    const url="https://script.google.com/macros/s/AKfycbzZO7OrMVvXYkCeQPY0FHut-5CeEVFHGprAxzQHX7p66yaZF0-NI9f4rXGrHd5wGKX6/exec?action=getRevenue";
    try{
      const res=await fetch(url); const data=await res.json();
      document.getElementById("revenueResult").innerText="Doanh thu tháng: "+data.revenue.toLocaleString()+" đ";
    }catch(e){ alert("Không lấy được doanh thu"); }
  }
</script>
</body>
</html>
