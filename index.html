<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>C√†y Rank & Thu√™ Slot (Sheets)</title>
<style>
  *,*::before,*::after{box-sizing:border-box}
  :root{--bg:#0f172a;--card:#111827;--muted:#94a3b8;--fg:#e5e7eb;--acc:#22c55e;--border:#1f2937;--warn:#f59e0b;
        --fs-base:15px;--pad:12px;--btn-pad:12px;--minh:44px;--big:36px}
  body.compact{--fs-base:13px;--pad:8px;--btn-pad:9px;--minh:36px;--big:30px}
  html,body{height:100%}
  body{
    margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    background:linear-gradient(160deg,#0b1020,#111827 45%,#0b1020);color:var(--fg);display:block;overflow-x:hidden
  }
  .wrap{max-width:980px;width:100%;margin:16px auto;padding:0 12px}
  .card{background:rgba(17,24,39,.9);border:1px solid var(--border);border-radius:18px;padding:16px;box-shadow:0 15px 40px rgba(0,0,0,.35)}
  h1{margin:0 0 8px 0;font-size:clamp(18px,3.6vw,28px)}
  p.lead{margin:0 0 12px 0;color:var(--muted);font-size:14px;line-height:1.4}
  .grid{display:grid;grid-template-columns:repeat(6,1fr);gap:12px;margin-top:12px}
  .col-2{grid-column:span 2}.col-3{grid-column:span 3}.col-4{grid-column:span 4}.col-6{grid-column:span 6}
  .pane{background:#0b1220;border:1px solid var(--border);border-radius:14px;padding:12px}
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  select,input[type="number"],input[type="text"]{
    width:100%;padding:var(--pad);border-radius:10px;border:1px solid var(--border);
    background:#0e1627;color:var(--fg);font-size:var(--fs-base);outline:none;min-height:var(--minh)
  }
  .controls{display:grid;grid-template-columns:1.2fr .8fr .8fr;gap:8px}
  .controls-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
  .inline{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .btn{cursor:pointer;border:1px solid #2a3446;background:#0e1627;color:var(--fg);padding:var(--btn-pad) 14px;border-radius:12px;font-weight:700;min-height:var(--minh)}
  .btn.primary{background:var(--acc);border-color:#16a34a;color:#052e16}
  .stat{background:linear-gradient(180deg,#0a1426,#0c1220);border:1px dashed #22304a;border-radius:14px;padding:14px}
  .big{font-size:clamp(20px,5vw,var(--big));font-weight:800}
  .muted{color:var(--muted)}
  .table-wrap{width:100%;overflow-x:auto;border-radius:10px}
  table{width:100%;border-collapse:collapse;font-size:14px;min-width:560px}
  th,td{border-bottom:1px solid #1f2937;padding:8px 6px;text-align:left}
  .price-edit{width:110px}
  .footer{margin-top:10px;font-size:12px;color:#9ca3af}
  .note{font-size:12px;color:#c7d2fe}
  .pill{display:inline-block;padding:2px 8px;border:1px solid #334155;border-radius:999px;font-size:12px;color:#cbd5e1}
  .ct-badge{font-size:12px;color:#fde68a}
  .warn{font-size:12px;color:var(--warn);margin-top:6px}
  @media (max-width:1024px){.grid{grid-template-columns:1fr 1fr}.col-2,.col-3,.col-4,.col-6{grid-column:span 2}}
  @media (max-width:640px){
    .grid{grid-template-columns:1fr}
    .col-2,.col-3,.col-4,.col-6{grid-column:span 1}
    .controls,.controls-3{grid-template-columns:1fr;gap:8px}
    .pane{padding:10px}
    #actionRow{flex-direction:column;align-items:stretch;gap:10px}
    #actionRow .inline:last-child{width:100%}
    .btn{width:100%}
  }
  /* Thanh tr∆∞·ª£t cu·ªôn trang */
  #scrollBarWrap{
    position:fixed;left:0;right:0;bottom:0;padding:6px 10px;background:rgba(2,6,23,.75);
    backdrop-filter:blur(6px);border-top:1px solid #0b1220;z-index:50
  }
  #scrollSlider{width:100%;appearance:none;height:6px;border-radius:999px;background:#1f2937;outline:none}
  #scrollSlider::-webkit-slider-thumb{appearance:none;width:18px;height:18px;border-radius:50%;background:#22c55e;border:2px solid #14532d}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>üõ°Ô∏è C√†y Rank & Thu√™ Slot</h1>
      <p class="lead">
        <span class="inline" style="gap:12px">
          <span>T√≠nh c√†y rank & thu√™ slot (t√°ch ri√™ng). L∆∞u ƒë∆°n v√†o Google Sheets.</span>
          <label class="inline" style="gap:6px;cursor:pointer">
            <input id="compactToggle" type="checkbox"/><span class="pill">Ch·∫ø ƒë·ªô g·ªçn (mobile)</span>
          </label>
        </span><br>
        <span class="ct-badge">T·ª´ <b>Cao th·ªß</b> nh·∫≠p t·ªïng sao: CT 1‚Äì9 ‚Ä¢ ƒêCT 10‚Äì49 ‚Ä¢ CT∆∞·ªõng ‚â•50. <b>CT ‚â•70‚òÖ = 20.000ƒë/‚òÖ</b>.</span>
      </p>

      <div class="grid">
        <!-- ===== C√ÄY RANK ===== -->
        <div class="pane col-3">
          <label>Rank hi·ªán t·∫°i</label>
          <div class="controls">
            <select id="fromTier"></select>
            <div id="fromDivWrap"></div>
            <div id="fromStarsWrap"></div>
          </div>
          <div id="fromWarn" class="warn" style="display:none"></div>
        </div>

        <div class="pane col-3">
          <label>Rank m·ª•c ti√™u</label>
          <div class="controls">
            <select id="toTier"></select>
            <div id="toDivWrap"></div>
            <div id="toStarsWrap"></div>
          </div>
          <div id="toWarn" class="warn" style="display:none"></div>
        </div>

        <div class="pane col-6">
          <div class="inline" id="actionRow" style="justify-content:space-between">
            <div class="inline">
              <input id="carry" type="checkbox" checked style="width:18px;height:18px"/>
              <label for="carry" style="margin:0">C·ªông 1 sao khi thƒÉng h·∫°ng (√°p d·ª•ng khi l√™n b·∫≠c KC/TA ‚Üí b·∫≠c cao h∆°n).</label>
            </div>
            <div class="inline" style="gap:8px">
              <button class="btn" id="swap">ƒê·ªïi ch·ªó (‚Üë‚Üì)</button>
              <button class="btn primary" id="calc">T√≠nh c√†y rank</button>
            </div>
          </div>
        </div>

        <div class="pane col-4 stat">
          <div class="muted">T·ªïng s·ªë sao (c√†y rank)</div>
          <div id="starsTotal" class="big">0</div>
        </div>
        <div class="pane col-2 stat">
          <div class="muted">Ti·ªÅn c√†y rank (VND)</div>
          <div id="priceTotal" class="big">0</div>
        </div>

        <!-- Th√¥ng tin & L∆ØU c·ªßa C√†y rank -->
        <div class="pane col-6">
          <b>Th√¥ng tin ƒë∆°n C√†y rank</b>
          <div class="controls-3">
            <input id="rankStaff" type="text" placeholder="N√¥ l·ªá">
            <input id="rankCustomer" type="text" placeholder="Th∆∞·ª£ng ƒë·∫ø (t√™n/SDT)">
            <input id="rankNote" type="text" placeholder="Ghi ch√∫ (t∆∞·ªõng, y√™u c·∫ßu‚Ä¶)">
          </div>
          <div class="inline" style="margin-top:10px;gap:8px;flex-wrap:wrap">
            <button class="btn" onclick="saveOrder()">üíæ L∆∞u ƒë∆°n C√†y rank</button>
            <span id="saveMsg" class="muted"></span>
          </div>
        </div>

        <div class="pane col-6">
          <div class="inline" style="justify-content:space-between">
            <div><b>B·∫£ng gi√° c√†y rank</b><div class="note">Ch·ªânh ƒë∆°n gi√° (ƒë/sao) theo b·∫≠c. CT ‚â•70‚òÖ t·ª± √°p 20.000ƒë/‚òÖ.</div></div>
            <button class="btn" id="resetPrice">Kh√¥i ph·ª•c m·∫∑c ƒë·ªãnh</button>
          </div>
          <div class="table-wrap">
            <table>
              <thead><tr><th>B·∫≠c rank</th><th>Gi√° (ƒë / 1 sao)</th></tr></thead>
              <tbody id="priceTable"></tbody>
            </table>
          </div>
        </div>

        <div class="pane col-6">
          <b>Chi ti·∫øt t√≠nh c√†y rank</b>
          <div class="table-wrap">
            <table>
              <thead><tr><th>Kho·∫£ng</th><th>S·ªë sao</th><th>ƒê∆°n gi√°</th><th>Th√†nh ti·ªÅn</th></tr></thead>
              <tbody id="breakdown"></tbody>
            </table>
          </div>
          <div class="footer">KC/TA: m·ªói division c√≥ 5 sao. Cao th·ªß tr·ªü l√™n nh·∫≠p t·ªïng sao.</div>
        </div>

        <!-- ===== THU√ä SLOT (T√ÅCH RI√äNG) ===== -->
        <div class="pane col-6">
          <b>Thu√™ slot (t√≠nh ri√™ng)</b>
          <div class="controls-3">
            <div><label>S·ªë gi·ªù thu√™</label><input id="slotHours" type="number" step="0.5" min="0" placeholder="VD 1.5" value="0"></div>
            <div><label>Gi√° / gi·ªù (ƒë)</label><input id="slotRate" type="number" min="0" step="1000" value="30000"></div>
            <div class="stat"><div class="muted">Ti·ªÅn thu√™ slot</div><div id="slotMoney" class="big">0</div></div>
          </div>
          <div class="controls-3" style="margin-top:8px">
            <input id="slotStaff" type="text" placeholder="N√¥ l·ªá (slot)">
            <input id="slotCustomer" type="text" placeholder="Th∆∞·ª£ng ƒë·∫ø (slot)">
            <input id="slotNote" type="text" placeholder="Ghi ch√∫ (slot)">
          </div>
          <div class="inline" style="margin-top:10px;gap:8px;flex-wrap:wrap">
            <button class="btn" id="calcSlot">T√≠nh thu√™ slot</button>
            <button class="btn" onclick="saveSlot()">üíæ L∆∞u ƒë∆°n Thu√™ slot</button>
          </div>
        </div>

        <!-- ===== DOANH THU TH√ÅNG (SHEETS) ===== -->
        <div class="pane col-6">
          <b>Doanh thu th√°ng (t·ª´ Sheets)</b>
          <div class="stat" style="margin-top:8px">
            <div class="muted">T·ªïng doanh thu th√°ng n√†y</div>
            <div id="monthMoney" class="big">0</div>
            <div class="muted">T·ªïng sao th√°ng n√†y: <span id="monthStars">0</span></div>
          </div>
          <div class="inline" style="margin-top:10px;gap:8px;flex-wrap:wrap">
            <button class="btn" id="fetchMonthly">üìÖ L·∫•y doanh thu th√°ng</button>
          </div>
        </div>

        <!-- ===== TH·ªêNG K√ä CHI TI·∫æT T·ª™ SHEETS ===== -->
        <div class="pane col-6" id="statsPane">
          <b>Th·ªëng k√™ (Sheets)</b>
          <div id="statsBox" class="muted" style="margin-top:8px">
            B·∫•m ‚ÄúL·∫•y doanh thu th√°ng‚Äù ƒë·ªÉ t·∫£i nhanh, ho·∫∑c b·∫•m d∆∞·ªõi ƒë·ªÉ xem Today & Top n√¥ l·ªá:
          </div>
          <div class="inline" style="margin-top:10px">
            <button class="btn" onclick="fetchStats()">üìä L·∫•y th·ªëng k√™ ƒë·∫ßy ƒë·ªß</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Thanh tr∆∞·ª£t cu·ªôn trang -->
  <div id="scrollBarWrap"><input id="scrollSlider" type="range" min="0" max="100" value="0"></div>

<script>
/* ====== GOOGLE SHEETS CONFIG ====== */
const SHEETS_URL = 'https://script.google.com/macros/s/AKfycbzZO7OrMVvXYkCeQPY0FHut-5CeEVFHGprAxzQHX7p66yaZF0-NI9f4rXGrHd5wGKX6/exec'; // v√≠ d·ª•: https://script.google.com/macros/s/XXXXX/exec
const API_KEY    = 'abc123';                    // tr√πng v·ªõi Apps Script

/* ====== NG∆Ø·ª†NG SAO ====== */
const CTU_MIN=1,  CTU_MAX=9;   // Cao th·ªß
const DCT_MIN=10, DCT_MAX=49;  // ƒê·∫°i cao th·ªß
const CT_MIN=50, CT_MAX=150;   // Chi·∫øn t∆∞·ªõng

/* ====== TI·ªÄN & B·∫¨C ====== */
const DIVS=[5,4,3,2,1], MAX_STARS=5;
const TIERS=["Kim C∆∞∆°ng","Tinh Anh","Cao th·ªß","ƒê·∫°i cao th·ªß","Chi·∫øn t∆∞·ªõng"];
const DEFAULT_PRICES={
  "Kim C∆∞∆°ng":3000,"Tinh Anh":5000,"Cao th·ªß":7000,"ƒê·∫°i cao th·ªß":10000,"Chi·∫øn t∆∞·ªõng":15000
};
let prices={...DEFAULT_PRICES};

/* === Chi·∫øn t∆∞·ªõng ‚â•70‚òÖ = 20.000ƒë/‚òÖ === */
const CT_HIGH_THRESHOLD = 70;
const CT_HIGH_PRICE     = 20000;

/* ====== TI·ªÜN √çCH ====== */
const el=id=>document.getElementById(id);
const option=list=>list.map(v=>`<option value="${v}">${v}</option>`).join("");
const idxTier=t=>TIERS.indexOf(t);
function fmt(n){try{return n.toLocaleString("vi-VN")}catch{return String(n)}}
function mkDiv(id){return `<select id="${id}">${option(DIVS)}</select>`}
function mkStar(id, allowZero=true){
  const arr = allowZero ? [0,1,2,3,4] : [1,2,3,4]; // M·ª•c ti√™u kh√¥ng cho 0‚òÖ
  return `<select id="${id}">${option(arr)}</select>`;
}
function mkAbs(id,min,max,ph){
  return `<input id="${id}" type="number" min="${min}" ${max?`max="${max}"`:""} step="1" placeholder="${ph}" value="${min}"/>`
}
function warnText(tier){
  if(tier==="Cao th·ªß") return `Nh·∫≠p t·ªïng sao ${CTU_MIN}‚Äì${CTU_MAX}.`;
  if(tier==="ƒê·∫°i cao th·ªß") return `Nh·∫≠p t·ªïng sao ${DCT_MIN}‚Äì${DCT_MAX}.`;
  if(tier==="Chi·∫øn t∆∞·ªõng") return `Nh·∫≠p t·ªïng sao ‚â• ${CT_MIN}.`;
  return "";
}

/* ====== RENDER INPUTS ====== */
function renderInputs(prefix){
  const tier=el(prefix+"Tier").value,divW=el(prefix+"DivWrap"),starW=el(prefix+"StarsWrap"),warn=el(prefix+"Warn");
  if(tier==="Kim C∆∞∆°ng"||tier==="Tinh Anh"){
    divW.innerHTML=mkDiv(prefix+"Div");
    const allowZero = (prefix!=="to");
    starW.innerHTML=mkStar(prefix+"Stars", allowZero);
    if(prefix==="to"){ const s=el("toStars"); if(s && Number(s.value)===0) s.value=1; }
    if(warn){warn.style.display="none";warn.textContent="";}
  }else if(tier==="Cao th·ªß"){
    divW.innerHTML=mkAbs(prefix+"ABS", CTU_MIN, CTU_MAX, `${CTU_MIN}‚Äì${CTU_MAX} sao`);
    starW.innerHTML="";
    if(warn){warn.style.display="block";warn.textContent=warnText(tier);}
  }else if(tier==="ƒê·∫°i cao th·ªß"){
    divW.innerHTML=mkAbs(prefix+"ABS", DCT_MIN, DCT_MAX, `${DCT_MIN}‚Äì${DCT_MAX} sao`);
    starW.innerHTML="";
    if(warn){warn.style.display="block";warn.textContent=warnText(tier);}
  }else{
    divW.innerHTML=mkAbs(prefix+"ABS", CT_MIN, CT_MAX, `‚â• ${CT_MIN} sao`);
    starW.innerHTML="";
    if(warn){warn.style.display="block";warn.textContent=warnText(tier);}
  }
  ["Div","Stars","ABS"].forEach(s=>{const n=document.getElementById(prefix+s); if(n) n.addEventListener("change",calc);});
}

function loadSelectors(){
  el("fromTier").innerHTML=option(TIERS);
  el("toTier").innerHTML=option(TIERS);
  el("fromTier").value="Kim C∆∞∆°ng";
  el("toTier").value="Kim C∆∞∆°ng";
  renderInputs("from"); renderInputs("to");
  if(el("fromDiv"))   el("fromDiv").value=3;
  if(el("fromStars")) el("fromStars").value=0;
  if(el("toDiv"))     el("toDiv").value=1;
  if(el("toStars"))   el("toStars").value=1; // m·ª•c ti√™u kh√¥ng cho 0‚òÖ
}

function loadPriceTable(){
  const tb=el("priceTable");
  tb.innerHTML=TIERS.map(t=>`<tr><td>${t}</td>
    <td><input class="price-edit" type="number" min="0" step="500" value="${prices[t]}" data-tier="${t}"/></td></tr>`
  ).join("");
  tb.querySelectorAll("input").forEach(inp=>{
    inp.addEventListener("input",e=>{
      const t=e.target.dataset.tier;
      prices[t]=Math.max(0,Math.round(Number(e.target.value||0)));
      calc();
    });
  });
}

/* ====== STATE ====== */
function getABS(prefix){
  const i=el(prefix+"ABS"); if(!i) return null;
  let v=Number(i.value||0);
  const tier=el(prefix+"Tier").value;
  if(tier==="Cao th·ªß"){ if(v<CTU_MIN) v=CTU_MIN; if(v>CTU_MAX) v=CTU_MAX; }
  else if(tier==="ƒê·∫°i cao th·ªß"){ if(v<DCT_MIN) v=DCT_MIN; if(v>DCT_MAX) v=DCT_MAX; }
  else if(tier==="Chi·∫øn t∆∞·ªõng"){ if(v<CT_MIN) v=CT_MIN; if(CT_MAX && v>CT_MAX) v=CT_MAX; }
  i.value=v; return v;
}
function getState(prefix){
  const tier=el(prefix+"Tier").value;
  if(tier==="Kim C∆∞∆°ng"||tier==="Tinh Anh")
    return {ti:idxTier(tier), di:Number(el(prefix+"Div").value), st:Number(el(prefix+"Stars").value)};
  return {ti:idxTier(tier), abs:getABS(prefix)};
}
function setState(prefix,obj){
  el(prefix+"Tier").value=TIERS[obj.ti]; renderInputs(prefix);
  if(obj.ti<=idxTier("Tinh Anh")){
    if(el(prefix+"Div"))   el(prefix+"Div").value=obj.di;
    if(el(prefix+"Stars")) el(prefix+"Stars").value=obj.st;
  }else{
    if(el(prefix+"ABS")) el(prefix+"ABS").value=obj.abs;
  }
}

/* ====== ORDER & STEP ====== */
function lt(a,b){
  if(a.ti!==b.ti) return a.ti<b.ti;
  if(a.ti<=idxTier("Tinh Anh")){
    if(a.di!==b.di) return a.di>b.di;
    return a.st<b.st;
  }
  return (a.abs||0)<(b.abs||0);
}
function notLT(a,b){return !lt(a,b)}

/* FIX: b∆∞·ªõc sao ƒë√∫ng 6 khi thƒÉng h·∫°ng KC/TA */
function stepOnce(cur, carry){
  if(cur.ti<=idxTier("Tinh Anh")){ // KC/TA
    if(cur.st<MAX_STARS){
      cur.st += 1; // tƒÉng sao trong c√πng division
    }else{
      // ƒëang 5/5 ‚Üí b∆∞·ªõc n√†y m·ªõi thƒÉng h·∫°ng
      if(cur.di>1){
        cur.di -= 1;            // TA2 ‚Üí TA1
        cur.st  = carry ? 1 : 0;
      }else{
        // t·ª´ 1 ‚Üí l√™n b·∫≠c cao h∆°n
        cur.ti += 1;
        if(cur.ti<=idxTier("Tinh Anh")){
          cur.di = 5;
          cur.st = carry ? 1 : 0;
        }else{
          // v√†o Cao th·ªß: chuy·ªÉn sang ƒë·∫øm sao tuy·ªát ƒë·ªëi
          cur.abs = carry ? CTU_MIN : 0; // cho 0 n·ªôi b·ªô, b∆∞·ªõc sau +1
          delete cur.di; delete cur.st;
        }
      }
    }
  }else{
    // t·ª´ Cao th·ªß tr·ªü l√™n: tƒÉng t·ªïng sao (kh√¥ng √°p carry)
    cur.abs = (cur.abs || (cur.ti===idxTier("Cao th·ªß")?CTU_MIN:DCT_MIN)) + 1;
    if(cur.ti===idxTier("Cao th·ªß")     && cur.abs>=DCT_MIN) cur.ti=idxTier("ƒê·∫°i cao th·ªß");
    if(cur.ti===idxTier("ƒê·∫°i cao th·ªß") && cur.abs>=CT_MIN)  cur.ti=idxTier("Chi·∫øn t∆∞·ªõng");
  }
}

/* ====== GI√Å THEO T·ª™NG B∆Ø·ªöC (CT 70‚òÖ+) ====== */
function priceForStep(prevState){
  const tierName = TIERS[prevState.ti];
  if (tierName === "Chi·∫øn t∆∞·ªõng"){
    const abs = Number(prevState.abs || 0);
    if (abs >= CT_HIGH_THRESHOLD) return CT_HIGH_PRICE; // 70‚òÖ tr·ªü l√™n
    return prices["Chi·∫øn t∆∞·ªõng"]; // d∆∞·ªõi 70‚òÖ d√πng gi√° c∆° b·∫£n c·ªßa CT
  }
  return prices[tierName]; // c√°c b·∫≠c kh√°c d√πng gi√° theo b·∫£ng
}

/* ====== L·ªò TR√åNH SAO (G·ªòP THEO ƒê∆†N GI√Å) ====== */
function* starPath(from, to, carry){
  // Duy·ªát t·ª´ng b∆∞·ªõc sao ƒë·ªÉ √°p gi√° ƒë√∫ng cho CT 70‚òÖ+
  // G·ªôp c√°c b∆∞·ªõc li√™n ti·∫øp c√≥ c√πng ƒë∆°n gi√° th√†nh 1 d√≤ng breakdown.
  let cur = JSON.parse(JSON.stringify(from));
  let segFrom  = JSON.parse(JSON.stringify(cur));
  let segTier  = cur.ti;
  let segPrice = priceForStep(cur);
  let segStars = 0;

  while (lt(cur, to)){
    const prev = JSON.parse(JSON.stringify(cur)); // tr·∫°ng th√°i TR∆Ø·ªöC b∆∞·ªõc
    const stepPrice = priceForStep(prev);         // ƒë∆°n gi√° √°p cho b∆∞·ªõc n√†y
    stepOnce(cur, carry);                         // ti·∫øn 1 sao

    // Khi gi√° ho·∫∑c b·∫≠c hi·ªÉn th·ªã thay ƒë·ªïi ‚Üí ch·ªët ƒëo·∫°n c≈©, m·ªü ƒëo·∫°n m·ªõi
    if (stepPrice !== segPrice || prev.ti !== segTier){
      if (segStars > 0){
        yield {
          from: {...segFrom},
          to:   {...prev},
          stars: segStars,
          pricePerStar: segPrice
        };
      }
      segFrom  = JSON.parse(JSON.stringify(prev));
      segTier  = prev.ti;
      segPrice = stepPrice;
      segStars = 0;
    }
    segStars += 1;
  }

  if (segStars > 0){
    yield {
      from: {...segFrom},
      to:   {...to},
      stars: segStars,
      pricePerStar: segPrice
    };
  }
}

function labelOf(s){
  const n=TIERS[s.ti];
  if(s.ti<=idxTier("Tinh Anh")) return `${n} ${s.di} ‚Ä¢ ${s.st}/5`;
  return `${n} ‚Ä¢ ${s.abs} sao`;
}

/* ====== CALC ====== */
function calc(){
  const from=getState("from"), to=getState("to"), carry=el("carry").checked, bd=el("breakdown"); bd.innerHTML="";
  if(notLT(from,to)){
    el("starsTotal").textContent="0"; el("priceTotal").textContent="0";
    bd.innerHTML=`<tr><td colspan="4"><span class="muted">M·ª•c ti√™u ph·∫£i cao h∆°n hi·ªán t·∫°i.</span></td></tr>`;
    return;
  }
  let starsTotal=0, priceTotal=0;
  for(const seg of starPath(from,to,carry)){
    starsTotal+=seg.stars; const m=seg.stars*seg.pricePerStar; priceTotal+=m;
    bd.innerHTML+=`<tr><td>${labelOf(seg.from)} ‚Üí ${labelOf(seg.to)}</td><td>${seg.stars}</td><td>${fmt(seg.pricePerStar)}</td><td><b>${fmt(m)}</b></td></tr>`;
  }
  el("starsTotal").textContent=fmt(starsTotal);
  el("priceTotal").textContent=fmt(priceTotal);
}
function swap(){const a=getState("from"), b=getState("to"); setState("from",b); setState("to",a); calc();}

/* ====== SLOT (T√ÅCH RI√äNG) ====== */
function calcSlotNow(){
  const h=Math.max(0,Number(el('slotHours').value||0));
  const rate=Math.max(0,Number(el('slotRate').value||0));
  el('slotMoney').textContent=fmt(Math.round(h*rate));
}
document.getElementById('calcSlot').addEventListener('click',calcSlotNow);
['slotHours','slotRate'].forEach(id=>el(id).addEventListener('input',calcSlotNow));

/* ====== SHEETS: SAVE & STATS ====== */
function snapshotRank(){
  const fromTier=el("fromTier").value, toTier=el("toTier").value; let from={tier:fromTier}, to={tier:toTier};
  if(idxTier(fromTier)<=idxTier("Tinh Anh")){
    from.div=Number(el("fromDiv").value); from.starsOrCT=Number(el("fromStars").value);
  }else{ from.starsOrCT=Number(el("fromABS").value); }
  if(idxTier(toTier)<=idxTier("Tinh Anh")){
    to.div=Number(el("toDiv").value); to.starsOrCT=Number(el("toStars").value);
  }else{ to.starsOrCT=Number(el("toABS").value); }
  const starsTotal=parseInt(el("starsTotal").textContent.replace(/\D/g,''))||0;
  const priceTotal=parseInt(el("priceTotal").textContent.replace(/\D/g,''))||0;
  return {
    staff:el("rankStaff").value.trim(),
    customer:el("rankCustomer").value.trim(),
    note:el("rankNote").value.trim(),
    from,to, carry:el("carry").checked, starsTotal, priceTotal
  };
}
async function saveOrder(){
  try{
    const payload={ apiKey:API_KEY, ...snapshotRank() };
    const res=await fetch(SHEETS_URL,{
      method:'POST',
      headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},
      body:new URLSearchParams({payload:JSON.stringify(payload)})
    });
    const t=await res.text(); let d={}; try{d=JSON.parse(t)}catch{d={ok:false,error:t}};
    el("saveMsg").textContent=d.ok?"‚úÖ ƒê√£ l∆∞u ƒë∆°n C√†y rank.":"‚ùå "+(d.error||"L·ªói");
  }catch(err){ el("saveMsg").textContent="‚ùå L·ªói m·∫°ng: "+err; }
}
async function saveSlot(){
  try{
    const h=Math.max(0,Number(el('slotHours').value||0));
    const rate=Math.max(0,Number(el('slotRate').value||0));
    const money=Math.round(h*rate);
    const payload={
      apiKey:API_KEY,
      staff:el("slotStaff").value.trim(),
      customer:el("slotCustomer").value.trim(),
      note:(el("slotNote").value.trim()||`Thu√™ slot ${h}h @${fmt(rate)}/h`),
      from:{tier:"Thu√™ slot"}, to:{tier:"Thu√™ slot"},
      carry:false, starsTotal:0, priceTotal:money
    };
    const res=await fetch(SHEETS_URL,{
      method:'POST',
      headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},
      body:new URLSearchParams({payload:JSON.stringify(payload)})
    });
    const t=await res.text(); let d={}; try{d=JSON.parse(t)}catch{d={ok:false,error:t}};
    el("saveMsg").textContent=d.ok?"‚úÖ ƒê√£ l∆∞u ƒë∆°n Thu√™ slot.":"‚ùå "+(d.error||"L·ªói");
  }catch(err){ el("saveMsg").textContent="‚ùå L·ªói m·∫°ng: "+err; }
}

/* ‚Äî‚Äî‚Äî Doanh thu th√°ng (t·ª´ Sheets) ‚Äî‚Äî‚Äî */
async function fetchMonthly(){
  try{
    const res=await fetch(SHEETS_URL+`?q=stats&apiKey=${encodeURIComponent(API_KEY)}`);
    const d=await res.json();
    if(!d.ok) { alert('Kh√¥ng l·∫•y ƒë∆∞·ª£c doanh thu th√°ng'); return; }
    el('monthMoney').textContent = (d.month.revenue||0).toLocaleString('vi-VN');
    el('monthStars').textContent = (d.month.stars||0).toLocaleString('vi-VN');
  }catch(err){ alert('L·ªói: '+err); }
}

/* ‚Äî‚Äî‚Äî Th·ªëng k√™ ƒë·∫ßy ƒë·ªß (Today + Top n√¥ l·ªá) ‚Äî‚Äî‚Äî */
async function fetchStats(){
  try{
    const res=await fetch(SHEETS_URL+`?q=stats&apiKey=${encodeURIComponent(API_KEY)}`);
    const d=await res.json();
    if(!d.ok){ el('statsBox').textContent='Kh√¥ng l·∫•y ƒë∆∞·ª£c th·ªëng k√™.'; return; }
    const v=n=>(n||0).toLocaleString('vi-VN');
    const byStaff=(d.byStaff||[]).map((s,i)=>`${i+1}. ${s.staff}: ${v(s.revenue)}ƒë (${s.stars} sao)`).join('<br>')||'‚Äî';
    el('statsBox').innerHTML =
      `<div><b>H√¥m nay:</b> ${v(d.today.revenue)}ƒë (${d.today.stars} sao)</div>
       <div><b>Th√°ng n√†y:</b> ${v(d.month.revenue)}ƒë (${d.month.stars} sao)</div>
       <div style="margin-top:6px"><b>Top n√¥ l·ªá:</b><br>${byStaff}</div>`;
  }catch(err){ el('statsBox').textContent='L·ªói: '+err; }
}

/* ====== INIT / SCROLLBAR ====== */
function updateSlider(){
  const max=Math.max(document.body.scrollHeight-window.innerHeight,1);
  el('scrollSlider').value=Math.round(window.scrollY/max*100);
}
el('scrollSlider').addEventListener('input',e=>{
  const max=Math.max(document.body.scrollHeight-window.innerHeight,1);
  const y=Math.round(max*(Number(e.target.value)||0)/100);
  window.scrollTo({top:y,behavior:'instant'});
});
window.addEventListener('scroll',updateSlider,{passive:true});
window.addEventListener('resize',updateSlider);

function init(){
  // selectors + price table
  loadSelectors(); loadPriceTable(); calc(); calcSlotNow();
  ["fromTier","toTier"].forEach(id=>{
    el(id).addEventListener("change",e=>{
      renderInputs(id.replace("Tier","")); calc();
    });
  });
  el("calc").addEventListener("click",calc);
  el("swap").addEventListener("click",swap);
  el("resetPrice").addEventListener("click",()=>{prices={...DEFAULT_PRICES}; loadPriceTable(); calc();});
  el("carry").addEventListener("change",calc);
  el("compactToggle").addEventListener("change",(e)=>document.body.classList.toggle("compact",e.target.checked));
  el("fetchMonthly").addEventListener("click", fetchMonthly);
  updateSlider();
}
init();
</script>
</body>
</html>
