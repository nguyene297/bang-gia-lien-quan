<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>T√≠nh Sao & Gi√° C√†y Rank Li√™n Qu√¢n + Doanh thu (Sheets)</title>
<style>
  *,*::before,*::after{box-sizing:border-box}
  :root{
    --bg:#0f172a;--card:#111827;--muted:#94a3b8;--fg:#e5e7eb;
    --acc:#22c55e;--border:#1f2937;--warn:#f59e0b;
    --fs-base:15px; --pad:12px; --btn-pad:12px; --minh:44px; --big:36px;
  }
  /* Ch·∫ø ƒë·ªô g·ªçn ~20% */
  body.compact{ --fs-base:13px; --pad:8px; --btn-pad:9px; --minh:36px; --big:30px; }

  html,body{height:100%}
  body{
    margin:0; font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    background:linear-gradient(160deg,#0b1020,#111827 45%,#0b1020); color:var(--fg);
    /* B·ªé cƒÉn gi·ªØa ƒë·ªÉ tr√°nh che m·∫•t ph·∫ßn ƒë·∫ßu tr√™n mobile */
    display:block; overflow-x:hidden;
  }
  .wrap{max-width:980px; width:100%; margin:16px auto; padding:0 12px;}
  .card{background:rgba(17,24,39,.9); border:1px solid var(--border); border-radius:18px; padding:16px; box-shadow:0 15px 40px rgba(0,0,0,.35); backdrop-filter:blur(6px)}
  h1{margin:0 0 8px 0; font-size:clamp(18px,3.6vw,28px)}
  p.lead{margin:0 0 12px 0; color:var(--muted); font-size:14px; line-height:1.4}
  .grid{display:grid; grid-template-columns:repeat(6,1fr); gap:12px; margin-top:12px}
  .col-2{grid-column:span 2}.col-3{grid-column:span 3}.col-4{grid-column:span 4}.col-6{grid-column:span 6}
  .pane{background:#0b1220; border:1px solid var(--border); border-radius:14px; padding:12px}
  label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
  select,input[type="number"],input[type="text"]{
    width:100%; padding:var(--pad); border-radius:10px; border:1px solid var(--border);
    background:#0e1627; color:var(--fg); font-size:var(--fs-base); outline:none; min-height:var(--minh)
  }
  .controls{display:grid; grid-template-columns:1.2fr .8fr .8fr; gap:8px}
  .inline{display:flex; align-items:center; gap:8px; flex-wrap:wrap}
  .btn{cursor:pointer; border:1px solid #2a3446; background:#0e1627; color:var(--fg);
       padding:var(--btn-pad) 14px; border-radius:12px; font-weight:700; min-height:var(--minh)}
  .btn.primary{background:var(--acc); border-color:#16a34a; color:#052e16}
  .stat{background:linear-gradient(180deg,#0a1426,#0c1220); border:1px dashed #22304a; border-radius:14px; padding:14px}
  .big{font-size:clamp(20px,5vw,var(--big)); font-weight:800}
  .muted{color:var(--muted)}
  .table-wrap{width:100%; overflow-x:auto; border-radius:10px}
  table{width:100%; border-collapse:collapse; font-size:14px; min-width:560px}
  th,td{border-bottom:1px solid #1f2937; padding:8px 6px; text-align:left}
  .price-edit{width:110px}
  .footer{margin-top:10px; font-size:12px; color:#9ca3af}
  .note{font-size:12px; color:#c7d2fe}
  .pill{display:inline-block; padding:2px 8px; border:1px solid #334155; border-radius:999px; font-size:12px; color:#cbd5e1}
  .ct-badge{font-size:12px; color:#fde68a}
  .warn{font-size:12px; color:var(--warn); margin-top:6px}

  /* Tablet ‚â§1024px: 2 c·ªôt */
  @media (max-width:1024px){
    .grid{grid-template-columns:1fr 1fr}
    .col-2,.col-3,.col-4,.col-6{grid-column:span 2}
  }
  /* Mobile ‚â§640px: 1 c·ªôt + n√∫t x·∫øp d·ªçc */
  @media (max-width:640px){
    .grid{grid-template-columns:1fr}
    .col-2,.col-3,.col-4,.col-6{grid-column:span 1}
    .controls{grid-template-columns:1fr; gap:8px}
    .pane{padding:10px}
    #actionRow{flex-direction:column; align-items:stretch; gap:10px}
    #actionRow .inline:last-child{width:100%}
    .btn{width:100%}
  }

  /* Thanh tr∆∞·ª£t cu·ªôn trang */
  #scrollBarWrap{
    position:fixed; left:0; right:0; bottom:0; padding:6px 10px;
    background:rgba(2,6,23,.75); backdrop-filter:blur(6px); border-top:1px solid #0b1220; z-index:50;
  }
  #scrollSlider{ width:100%; appearance:none; height:6px; border-radius:999px; background:#1f2937; outline:none }
  #scrollSlider::-webkit-slider-thumb{ appearance:none; width:18px; height:18px; border-radius:50%; background:#22c55e; border:2px solid #14532d }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>üõ°Ô∏è T√≠nh Sao & Gi√° C√†y Rank Li√™n Qu√¢n</h1>
      <p class="lead">
        <span class="inline" style="gap:12px">
          <span>Ch·ªçn rank hi·ªán t·∫°i v√† m·ª•c ti√™u ƒë·ªÉ t√≠nh <b>sao</b> & <b>gi√°</b>.</span>
          <label class="inline" style="gap:6px; cursor:pointer">
            <input id="compactToggle" type="checkbox" />
            <span class="pill">Ch·∫ø ƒë·ªô g·ªçn (mobile)</span>
          </label>
        </span>
        <br/><span class="ct-badge">Chi·∫øn t∆∞·ªõng: nh·∫≠p t·ªïng sao (‚â• 50).</span>
      </p>

      <div class="grid">
        <div class="pane col-3">
          <label>Rank hi·ªán t·∫°i</label>
          <div class="controls">
            <select id="fromTier"></select>
            <div id="fromDivWrap"></div>
            <div id="fromStarsWrap"></div>
          </div>
          <div id="fromWarn" class="warn" style="display:none">Chi·∫øn t∆∞·ªõng ph·∫£i ‚â• 50 sao.</div>
        </div>

        <div class="pane col-3">
          <label>Rank m·ª•c ti√™u</label>
          <div class="controls">
            <select id="toTier"></select>
            <div id="toDivWrap"></div>
            <div id="toStarsWrap"></div>
          </div>
          <div id="toWarn" class="warn" style="display:none">Chi·∫øn t∆∞·ªõng ph·∫£i ‚â• 50 sao.</div>
        </div>

        <div class="pane col-6">
          <div class="inline" id="actionRow" style="justify-content:space-between">
            <div class="inline">
              <input id="carry" type="checkbox" checked style="width:18px; height:18px"/>
              <label for="carry" style="margin:0">C·ªông 1 sao khi thƒÉng h·∫°ng <span class="pill">VD KC3 ‚Üí KC1 = 9 sao</span></label>
            </div>
            <div class="inline" style="gap:8px">
              <button class="btn" id="swap">ƒê·ªïi ch·ªó (‚Üë‚Üì)</button>
              <button class="btn primary" id="calc">T√≠nh ngay</button>
            </div>
          </div>
        </div>

        <div class="pane col-4 stat">
          <div class="muted">T·ªïng s·ªë sao</div>
          <div id="starsTotal" class="big">0</div>
        </div>
        <div class="pane col-2 stat">
          <div class="muted">T·ªïng ti·ªÅn (VND)</div>
          <div id="priceTotal" class="big">0</div>
        </div>

        <div class="pane col-6">
          <div class="inline" style="justify-content:space-between">
            <div><b>B·∫£ng gi√° m·ªói b·∫≠c</b><div class="note">C√≥ th·ªÉ ch·ªânh ƒë∆°n gi√° (ƒë/sao).</div></div>
            <button class="btn" id="resetPrice">Kh√¥i ph·ª•c m·∫∑c ƒë·ªãnh</button>
          </div>
          <div class="table-wrap">
            <table>
              <thead><tr><th>B·∫≠c rank</th><th>Gi√° (ƒë / 1 sao)</th></tr></thead>
              <tbody id="priceTable"></tbody>
            </table>
          </div>
        </div>

        <div class="pane col-6">
          <b>Chi ti·∫øt t√≠nh to√°n</b>
          <div class="table-wrap">
            <table>
              <thead><tr><th>Kho·∫£ng</th><th>S·ªë sao</th><th>ƒê∆°n gi√°</th><th>Th√†nh ti·ªÅn</th></tr></thead>
              <tbody id="breakdown"></tbody>
            </table>
          </div>
          <div class="footer">Division (5‚Üí1) = 5 sao. <b>Chi·∫øn t∆∞·ªõng:</b> nh·∫≠p t·ªïng sao (‚â• 50).</div>
        </div>

        <!-- Th√¥ng tin ƒë∆°n & l∆∞u Sheets -->
        <div class="pane col-6">
          <b>Th√¥ng tin ƒë∆°n h√†ng</b>
          <div class="controls" style="grid-template-columns:1fr 1fr 1fr">
            <input id="staff" type="text" placeholder="N√¥ l·ªá" />
            <input id="customer" type="text" placeholder="Th∆∞·ª£ng ƒë·∫ø" />
            <input id="note" type="text" placeholder="Ghi ch√∫ (t∆∞·ªõng, y√™u c·∫ßu‚Ä¶)" />
          </div>
          <div class="inline" style="margin-top:10px; gap:8px; flex-wrap:wrap">
            <button class="btn" onclick="saveOrder()">üíæ L∆∞u ƒë∆°n l√™n Google Sheets</button>
            <button class="btn" onclick="fetchStats()">üìä L·∫•y th·ªëng k√™</button>
            <span id="saveMsg" class="muted"></span>
          </div>
        </div>

        <div class="pane col-6" id="statsPane">
          <b>Th·ªëng k√™ doanh thu</b>
          <div id="statsBox" class="muted" style="margin-top:8px">Ch∆∞a t·∫£i th·ªëng k√™.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Thanh tr∆∞·ª£t cu·ªôn trang -->
  <div id="scrollBarWrap">
    <input id="scrollSlider" type="range" min="0" max="100" value="0" />
  </div>

<script>
/* ========== GOOGLE SHEETS CONFIG ========== */
const SHEETS_URL = 'https://script.google.com/macros/s/AKfycbzZO7OrMVvXYkCeQPY0FHut-5CeEVFHGprAxzQHX7p66yaZF0-NI9f4rXGrHd5wGKX6/exec';
const API_KEY    = 'const API_KEY    = 'abc123';  // API key gi·ªëng b√™n web
'; // ‚ö†Ô∏è ƒë·∫∑t gi·ªëng h·ªát API_KEY trong Code.gs c·ªßa b·∫°n

/* ========== APP CONFIG/LOGIC ========== */
const DIVS=[5,4,3,2,1],MAX_STARS=5,TIERS=["Kim C∆∞∆°ng","Tinh Anh","Cao th·ªß","ƒê·∫°i cao th·ªß","Chi·∫øn t∆∞·ªõng"];
const DEFAULT_PRICES={"Kim C∆∞∆°ng":3000,"Tinh Anh":5000,"Cao th·ªß":7000,"ƒê·∫°i cao th·ªß":10000,"Chi·∫øn t∆∞·ªõng":15000};
const CT_MIN=50;
let prices={...DEFAULT_PRICES};

const el=id=>document.getElementById(id);
const option=list=>list.map(v=>`<option value="${v}">${v}</option>`).join("");
const idxTier=t=>TIERS.indexOf(t);
function fmt(n){try{return n.toLocaleString("vi-VN")}catch{return String(n)}}
function mkDiv(id){return `<select id="${id}">${option(DIVS)}</select>`}
function mkStar(id){return `<select id="${id}">${option([0,1,2,3,4])}</select>`}
function mkCT(id){return `<input id="${id}" type="number" min="${CT_MIN}" step="1" placeholder="‚â• ${CT_MIN}" value="${CT_MIN}"/>`}

function renderInputs(prefix){
  const tier=el(prefix+"Tier").value,divW=el(prefix+"DivWrap"),starW=el(prefix+"StarsWrap"),warn=el(prefix+"Warn");
  if(tier==="Chi·∫øn t∆∞·ªõng"){divW.innerHTML=mkCT(prefix+"CTStars"); starW.innerHTML=""; if(warn) warn.style.display="block";}
  else {divW.innerHTML=mkDiv(prefix+"Div"); starW.innerHTML=mkStar(prefix+"Stars"); if(warn) warn.style.display="none";}
  ["Div","Stars","CTStars"].forEach(s=>{const n=document.getElementById(prefix+s); if(n) n.addEventListener("change",calc);});
}
function loadSelectors(){
  el("fromTier").innerHTML=option(TIERS); el("toTier").innerHTML=option(TIERS);
  ["from","to"].forEach(renderInputs);
  el("fromTier").value="Kim C∆∞∆°ng"; el("toTier").value="Kim C∆∞∆°ng"; renderInputs("from"); renderInputs("to");
  if(el("fromDiv")) el("fromDiv").value=3; if(el("fromStars")) el("fromStars").value=0;
  if(el("toDiv")) el("toDiv").value=1; if(el("toStars")) el("toStars").value=0;
}
function loadPriceTable(){
  const tb=el("priceTable");
  tb.innerHTML=TIERS.map(t=>`<tr><td>${t}</td><td><input class="price-edit" type="number" min="0" step="500" value="${prices[t]}" data-tier="${t}"/></td></tr>`).join("");
  tb.querySelectorAll("input").forEach(inp=>inp.addEventListener("input",e=>{const t=e.target.dataset.tier; prices[t]=Math.max(0,Math.round(Number(e.target.value||0))); calc();}));
}
function getCT(prefix){const i=el(prefix+"CTStars"); let v=Number((i?.value??CT_MIN)); if(isNaN(v)||v<CT_MIN){v=CT_MIN; if(i) i.value=CT_MIN;} return Math.floor(v)}
function getState(prefix){const tier=el(prefix+"Tier").value;
  if(tier==="Chi·∫øn t∆∞·ªõng") return {ti:idxTier(tier), ct:getCT(prefix)};
  return {ti:idxTier(tier), di:Number(el(prefix+"Div").value), st:Number(el(prefix+"Stars").value)};
}
function setState(prefix,obj){el(prefix+"Tier").value=TIERS[obj.ti]; renderInputs(prefix);
  if(obj.ti===idxTier("Chi·∫øn t∆∞·ªõng")){if(el(prefix+"CTStars")) el(prefix+"CTStars").value=Math.max(CT_MIN,obj.ct??CT_MIN);}
  else {if(el(prefix+"Div")) el(prefix+"Div").value=obj.di; if(el(prefix+"Stars")) el(prefix+"Stars").value=obj.st;}
}
function lt(a,b){ if(a.ti!==b.ti) return a.ti<b.ti;
  if(a.ti===idxTier("Chi·∫øn t∆∞·ªõng")) return (a.ct??CT_MIN)<(b.ct??CT_MIN);
  if(a.di!==b.di) return a.di>b.di; return a.st<b.st;
}
function notLT(a,b){return !lt(a,b)}
function* starPath(from,to,carry){
  let cur=JSON.parse(JSON.stringify(from)), last=idxTier("Chi·∫øn t∆∞·ªõng");
  const step=()=>{ if(cur.ti<last){
      cur.st+=1; if(cur.st>=MAX_STARS){cur.st=carry?1:0; if(cur.di>1){cur.di-=1}else{cur.ti+=1; if(cur.ti<last){cur.di=5}else{cur.ct=Math.max(CT_MIN,carry?CT_MIN+1:CT_MIN); delete cur.di; delete cur.st;}}}
    } else {cur.ct=Math.max(CT_MIN,(cur.ct??CT_MIN)+1);}
  };
  let stars=0, segFrom=JSON.parse(JSON.stringify(cur)), segTier=cur.ti;
  while(lt(cur,to)){step(); stars+=1; if(cur.ti!==segTier){yield {from:{...segFrom},to:{...cur},stars,pricePerStar:prices[TIERS[segTier]]}; segFrom=JSON.parse(JSON.stringify(cur)); segTier=cur.ti; stars=0;}}
  if(stars>0){yield {from:{...segFrom},to:{...to},stars,pricePerStar:prices[TIERS[segTier]]};}
}
function labelOf(s){const n=TIERS[s.ti]; return n==="Chi·∫øn t∆∞·ªõng" ? `${n} ‚Ä¢ ${(s.ct??CT_MIN)} sao` : `${n} ${s.di} ‚Ä¢ ${s.st}/${MAX_STARS}`;}
function calc(){
  const from=getState("from"), to=getState("to"), carry=el("carry").checked, bd=el("breakdown"); bd.innerHTML="";
  if(notLT(from,to)){el("starsTotal").textContent="0"; el("priceTotal").textContent="0"; bd.innerHTML=`<tr><td colspan="4"><span class="muted">M·ª•c ti√™u ph·∫£i cao h∆°n hi·ªán t·∫°i.</span></td></tr>`; return;}
  let starsTotal=0, priceTotal=0;
  for(const seg of starPath(from,to,carry)){starsTotal+=seg.stars; const m=seg.stars*seg.pricePerStar; priceTotal+=m;
    bd.innerHTML+=`<tr><td>${labelOf(seg.from)} ‚Üí ${labelOf(seg.to)}</td><td>${seg.stars}</td><td>${fmt(seg.pricePerStar)}</td><td><b>${fmt(m)}</b></td></tr>`;}
  el("starsTotal").textContent=fmt(starsTotal); el("priceTotal").textContent=fmt(priceTotal);
}
function swap(){const a=getState("from"), b=getState("to"); setState("from",b); setState("to",a); calc();}

// === Google Sheets: snapshot + save + stats ===
function snapshotOrder(){
  const fromTier=el("fromTier").value, toTier=el("toTier").value;
  let from={tier:fromTier}, to={tier:toTier};
  if(fromTier==="Chi·∫øn t∆∞·ªõng") from.starsOrCT=Number(el("fromCTStars").value);
  else { from.div=Number(el("fromDiv").value); from.starsOrCT=Number(el("fromStars").value); }
  if(toTier==="Chi·∫øn t∆∞·ªõng") to.starsOrCT=Number(el("toCTStars").value);
  else { to.div=Number(el("toDiv").value); to.starsOrCT=Number(el("toStars").value); }
  const starsTotal=parseInt(el("starsTotal").textContent.replace(/\D/g,''))||0;
  const priceTotal=parseInt(el("priceTotal").textContent.replace(/\D/g,''))||0;
  return {
    staff: el("staff").value.trim(),
    customer: el("customer").value.trim(),
    note: el("note").value.trim(),
    from, to,
    carry: el("carry").checked,
    starsTotal, priceTotal
  };
}
async function saveOrder(){
  try{
    if(!SHEETS_URL || !API_KEY){ alert("Ch∆∞a c·∫•u h√¨nh SHEETS_URL / API_KEY"); return; }
    const order=snapshotOrder();
    const payload={ apiKey:API_KEY, ...order };
    const body=new URLSearchParams({ payload: JSON.stringify(payload) });
    const res=await fetch(SHEETS_URL,{ method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'}, body });
    const data=await res.json().catch(()=>({ok:false,error:"Bad JSON"}));
    el("saveMsg").textContent = data.ok ? "‚úÖ ƒê√£ l∆∞u ƒë∆°n." : ("‚ùå L·ªói: " + (data.error||""));
  }catch(err){ el("saveMsg").textContent="‚ùå L·ªói m·∫°ng: "+err; }
}
async function fetchStats(){
  try{
    if(!SHEETS_URL || !API_KEY){ alert("Ch∆∞a c·∫•u h√¨nh SHEETS_URL / API_KEY"); return; }
    const url=SHEETS_URL+`?q=stats&apiKey=${encodeURIComponent(API_KEY)}`;
    const res=await fetch(url); const data=await res.json();
    if(!data.ok){ el('statsBox').textContent='Kh√¥ng l·∫•y ƒë∆∞·ª£c th·ªëng k√™.'; return; }
    const v=(n)=> (n||0).toLocaleString('vi-VN');
    const byStaff=(data.byStaff||[]).map((s,i)=> `${i+1}. ${s.staff}: ${v(s.revenue)}ƒë (${s.stars} sao)`).join('<br>') || '‚Äî';
    el('statsBox').innerHTML = `
      <div><b>H√¥m nay:</b> ${v(data.today.revenue)}ƒë (${data.today.stars} sao)</div>
      <div><b>Th√°ng n√†y:</b> ${v(data.month.revenue)}ƒë (${data.month.stars} sao)</div>
      <div style="margin-top:6px"><b>Top nh√¢n vi√™n:</b><br>${byStaff}</div>
    `;
  }catch(err){ el('statsBox').textContent='L·ªói: '+err; }
}

/* ========== INIT & EVENTS ========== */
function loadPriceTable(){
  const tb=el("priceTable");
  tb.innerHTML=TIERS.map(t=>`<tr><td>${t}</td><td><input class="price-edit" type="number" min="0" step="500" value="${prices[t]}" data-tier="${t}"/></td></tr>`).join("");
  tb.querySelectorAll("input").forEach(inp=>inp.addEventListener("input",e=>{const t=e.target.dataset.tier; prices[t]=Math.max(0,Math.round(Number(e.target.value||0))); calc();}));
}
loadSelectors(); loadPriceTable();
setState("from",{ti:idxTier("Kim C∆∞∆°ng"),di:3,st:0});
setState("to",{ti:idxTier("Kim C∆∞∆°ng"),di:1,st:0});
calc();
["fromTier","toTier"].forEach(id=>el(id).addEventListener("change",e=>{renderInputs(id.replace("Tier","")); calc();}));
el("calc").addEventListener("click",calc);
el("swap").addEventListener("click",swap);
el("resetPrice").addEventListener("click",()=>{prices={...DEFAULT_PRICES}; loadPriceTable(); calc();});
el("carry").addEventListener("change",calc);
el("compactToggle").addEventListener("change", (e)=> document.body.classList.toggle("compact", e.target.checked));

/* Thanh tr∆∞·ª£t cu·ªôn trang: slider ‚Üî scroll */
const slider=el('scrollSlider');
function updateSlider(){ const max=Math.max(document.body.scrollHeight - window.innerHeight, 1); slider.value = Math.round(window.scrollY / max * 100); }
window.addEventListener('scroll', updateSlider, {passive:true});
window.addEventListener('resize', updateSlider);
slider.addEventListener('input', (e)=> {
  const max=Math.max(document.body.scrollHeight - window.innerHeight, 1);
  const y = Math.round(max * (Number(e.target.value)||0) / 100);
  window.scrollTo({ top:y, behavior:'instant' });
});
updateSlider();
</script>
</body>
</html>
